<!-- challenge-form.component.html (Design Mobile Moderne) -->
<ion-header [translucent]="true" class="modern-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="onCancel()" class="back-button">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ isEditMode ? 'Modifier' : 'Nouveau défi' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button 
        (click)="onSubmit()" 
        [disabled]="challengeForm.invalid || isLoading"
        class="save-button">
        <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
        <span *ngIf="!isLoading">{{ isEditMode ? 'Sauver' : 'Créer' }}</span>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="modern-content">
  <form [formGroup]="challengeForm" class="modern-form">
    
    <!-- Image de couverture -->
    <div class="cover-section">
      <div class="cover-wrapper" [class.has-image]="coverImagePreview">
        <img *ngIf="coverImagePreview" [src]="coverImagePreview" alt="Cover" class="cover-img" />
        <div class="cover-placeholder" *ngIf="!coverImagePreview">
          <ion-icon name="image"></ion-icon>
          <p>Ajouter une image</p>
        </div>
        <div class="cover-actions">
          <ion-fab-button size="small" (click)="fileInput.click()" class="fab-action">
            <ion-icon [name]="coverImagePreview ? 'pencil' : 'camera'"></ion-icon>
          </ion-fab-button>
          <ion-fab-button 
            *ngIf="coverImagePreview" 
            size="small" 
            color="danger" 
            (click)="removeCoverImage()"
            class="fab-action">
            <ion-icon name="trash"></ion-icon>
          </ion-fab-button>
        </div>
        <input 
          type="file" 
          accept="image/*" 
          (change)="onCoverImageChange($event)"
          style="display: none"
          #fileInput>
      </div>
    </div>

    <!-- Contenu du formulaire -->
    <div class="form-content">
      
      <!-- Nom du défi -->
      <div class="input-group">
        <div class="input-header">
          <label class="input-label">Nom du défi <span class="required">*</span></label>
          <span class="char-counter">{{ challengeForm.get('name')?.value?.length || 0 }}/100</span>
        </div>
        <ion-input 
          formControlName="name"
          placeholder="Ex: Concours photo d'été"
          class="modern-input"
          [class.error]="challengeForm.get('name')?.invalid && challengeForm.get('name')?.touched">
        </ion-input>
        <div class="error-message" *ngIf="challengeForm.get('name')?.hasError('required') && challengeForm.get('name')?.touched">
          Ce champ est requis
        </div>
      </div>

      <!-- Description -->
      <div class="input-group">
        <div class="input-header">
          <label class="input-label">Description<span class="required">*</span></label>
          <span class="char-counter">{{ challengeForm.get('description')?.value?.length || 0 }}/1000</span>
        </div>
        <ion-textarea 
          formControlName="description"
          placeholder="Décrivez votre défi..."
          [autoGrow]="true"
          rows="4"
          class="modern-textarea"
          [class.error]="challengeForm.get('description')?.invalid && challengeForm.get('description')?.touched">
        </ion-textarea>
        <div class="error-message" *ngIf="challengeForm.get('description')?.hasError('required') && challengeForm.get('description')?.touched">
          Une description est requise
        </div>
      </div>

      <!-- Durée et dates -->
      <div class="section-title">
        <ion-icon name="calendar-outline"></ion-icon>
        <span>Période</span>
      </div>

      <div class="date-selectors">
        <div class="date-item">
          <label class="input-label">
            <ion-icon name="play-circle-outline"></ion-icon>
            Début<span class="required">*</span>
          </label>
          <ion-datetime-button datetime="startDate" class="date-button"></ion-datetime-button>
          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime 
                id="startDate" 
                formControlName="start_date" 
                presentation="date"
                [min]="today"
                [showDefaultButtons]="true">
              </ion-datetime>
            </ng-template>
          </ion-modal>
        </div>

        <div class="date-item">
          <label class="input-label">
            <ion-icon name="stop-circle-outline"></ion-icon>
            Durée
          </label>
          <div class="duration-display">
            <ion-input 
              formControlName="duration_days"
              type="number"
              min="1"
              max="365"
              placeholder="7"
              class="modern-input duration-input-compact">
            </ion-input>
            <span class="duration-label">jours</span>
          </div>
        </div>
      </div>

      <!-- Affichage de la date de fin calculée -->
      <div class="computed-date" *ngIf="computedEndDate">
        <ion-icon name="information-circle-outline"></ion-icon>
        <span>Se termine le {{ computedEndDate | date:'dd/MM/yyyy' }}</span>
      </div>

      <!-- Règle de vote -->
      <div class="section-title">
        <ion-icon name="thumbs-up-outline"></ion-icon>
        <span>Vote</span>
      </div>

      <div class="vote-options">
        <div 
          class="vote-card"
          [class.selected]="challengeForm.get('vote_rule')?.value === 'one_vote_per_user'"
          (click)="challengeForm.patchValue({vote_rule: 'one_vote_per_user'})">
          <ion-icon name="person"></ion-icon>
          <div class="vote-info">
            <h4>Un vote par personne</h4>
            <p>Chaque utilisateur vote une fois</p>
          </div>
          <div class="vote-check">
            <ion-icon name="checkmark-circle" *ngIf="challengeForm.get('vote_rule')?.value === 'one_vote_per_user'"></ion-icon>
          </div>
        </div>

        <div 
          class="vote-card"
          [class.selected]="challengeForm.get('vote_rule')?.value === 'unlimited_votes'"
          (click)="challengeForm.patchValue({vote_rule: 'unlimited_votes'})">
          <ion-icon name="infinite"></ion-icon>
          <div class="vote-info">
            <h4>Votes illimités</h4>
            <p>Les utilisateurs peuvent voter plusieurs fois</p>
          </div>
          <div class="vote-check">
            <ion-icon name="checkmark-circle" *ngIf="challengeForm.get('vote_rule')?.value === 'unlimited_votes'"></ion-icon>
          </div>
        </div>
      </div>

      <!-- Action principale -->
      <div class="input-group">
        <label class="input-label">Bouton d'action</label>
        <ion-select 
          formControlName="call_to_action"
          placeholder="Choisir une action"
          interface="action-sheet"
          class="modern-select">
          <ion-select-option *ngFor="let action of callToActionOptions" [value]="action">
            {{ action }}
          </ion-select-option>
        </ion-select>
      </div>

      <!-- Récompense -->
      <div class="section-title">
        <ion-icon name="gift-outline"></ion-icon>
        <span>Récompense</span>
      </div>

      <div class="input-group">
        <ion-input 
          formControlName="prize"
          placeholder="Ex: 500€, iPhone, Formation..."
          class="modern-input">
        </ion-input>
      </div>

      <!-- Règles -->
      <div class="section-title">
        <ion-icon name="list-outline"></ion-icon>
        <span>Règles du défi</span>
        <ion-button fill="clear" size="small" (click)="addRule()">
          <ion-icon name="add-circle" slot="icon-only"></ion-icon>
        </ion-button>
      </div>

      <div formArrayName="rules" class="rules-list">
        <div *ngFor="let rule of rules.controls; let i = index" class="rule-row">
          <div class="rule-number">{{ i + 1 }}</div>
          <ion-input 
            [formControlName]="i"
            placeholder="Règle du défi"
            class="modern-input rule-input">
          </ion-input>
          <ion-button 
            fill="clear" 
            color="medium" 
            (click)="removeRule(i)"
            *ngIf="rules.length > 1"
            class="remove-rule">
            <ion-icon name="close-circle" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </div>

      <!-- Options -->
      <div class="section-title">
        <ion-icon name="options-outline"></ion-icon>
        <span>Options</span>
      </div>

      <div class="toggle-card">
        <div class="toggle-content">
          <div class="toggle-icon">
            <ion-icon name="flash"></ion-icon>
          </div>
          <div class="toggle-info">
            <h4>Défi actif</h4>
            <p>Visible par tous les utilisateurs</p>
          </div>
        </div>
        <ion-toggle 
          formControlName="is_active"
          class="modern-toggle">
        </ion-toggle>
      </div>

      <div class="toggle-card">
        <div class="toggle-content">
          <div class="toggle-icon">
            <ion-icon name="ticket-outline"></ion-icon>
          </div>
          <div class="toggle-info">
            <h4>Coupon requis</h4>
            <p>Nécessite un coupon pour participer</p>
          </div>
        </div>
        <ion-toggle 
          formControlName="coupon_required"
          class="modern-toggle">
        </ion-toggle>
      </div>

      <div class="toggle-card">
        <div class="toggle-content">
          <div class="toggle-icon">
            <ion-icon name="check-circle-outline"></ion-icon>
          </div>
          <div class="toggle-info">
            <h4>Acceptance automatique</h4>
            <p>Les demandes de particapation accepter sans révision</p>
          </div>
        </div>
        <ion-toggle 
          formControlName="is_acceptance_automatique"
          class="modern-toggle">
        </ion-toggle>
      </div>

      <div class="input-group">
        <div class="input-header">
          <label class="input-label">
            <ion-icon name="people-outline"></ion-icon>
            Participations maximales
          </label>
        </div>
        <ion-input 
          formControlName="entries_count"
          type="number"
          min="1"
          placeholder="Illimité"
          class="modern-input">
        </ion-input>
        <div class="input-hint">Laissez vide pour illimité</div>
      </div>

    </div>

    <!-- Bouton flottant de soumission -->
    <div class="submit-footer">
      <ion-button 
        expand="block" 
        (click)="onSubmit()"
        [disabled]="challengeForm.invalid || isLoading"
        class="submit-btn">
        <ion-spinner *ngIf="isLoading" name="crescent" slot="start"></ion-spinner>
        <ion-icon *ngIf="!isLoading" name="rocket" slot="start"></ion-icon>
        {{ isEditMode ? 'Mettre à jour' : 'Lancer le défi' }}
      </ion-button>
    </div>

  </form>
</ion-content>