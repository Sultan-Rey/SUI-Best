<ion-header class="ion-no-border">
  <ion-toolbar color="light">
    <ion-buttons slot="start">
      <ion-button (click)="prevStep()" *ngIf="currentStep > 1">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button (click)="close()" *ngIf="currentStep === 1">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="ion-text-center">
      <span *ngIf="currentStep === 1">Nouvelle publication</span>
      <span *ngIf="currentStep === 2">Détails</span>
      <span *ngIf="currentStep === 3 && isModalMode === false">Vérification</span>
      <span *ngIf="currentStep === 3 && isModalMode === true">Vérification</span>
      <span *ngIf="currentStep === 4 && isModalMode === false">Vérification</span>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="nextStep()" [disabled]="!canProceed()" *ngIf="currentStep < totalSteps">
        <span>Suivant</span>
      </ion-button>
      <ion-button (click)="submit()" [disabled]="!canSubmit()" *ngIf="currentStep === totalSteps">
        <span>Publier</span>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <ion-progress-bar [value]="currentStep / totalSteps" color="primary"></ion-progress-bar>
</ion-header>

<ion-content class="ion-padding" [fullscreen]="true">
  <!-- Étape 1: Sélection du média -->
  <div *ngIf="currentStep === 1" class="upload-step">
    <div class="upload-container" (click)="presentMediaOptions()" [class.has-file]="previewUrl">
      <div *ngIf="!previewUrl" class="upload-placeholder">
        <ion-icon name="images" class="upload-icon"></ion-icon>
        <h3>Ajouter des photos ou vidéos</h3>
        <p>Glissez des médias ici ou appuyez pour sélectionner</p>
      </div>
      
      <div *ngIf="previewUrl" class="media-preview">
        <div class="media-container">
          <img *ngIf="isImage()" [src]="previewUrl" alt="Aperçu">
          <video *ngIf="isVideo()" [src]="previewUrl" controls></video>
          <button class="remove-media" (click)="removeMedia($event)">
            <ion-icon name="close-circle"></ion-icon>
          </button>
        </div>
      </div>
    </div>

    <div class="quick-actions" *ngIf="!previewUrl">
      <ion-button fill="clear" (click)="takePhoto()" class="action-button">
        <ion-icon slot="start" name="camera"></ion-icon>
        Appareil photo
      </ion-button>
      <ion-button fill="clear" (click)="pickFromGallery()" class="action-button">
        <ion-icon slot="start" name="image"></ion-icon>
        Galerie
      </ion-button>
    </div>
  </div>

  <!-- Étape 2: Détails -->
  <div *ngIf="currentStep === 2" class="ion-padding">
    <ion-list lines="full" class="ion-margin-bottom">
      <ion-item>
        <ion-textarea
          [(ngModel)]="content.description"
          placeholder="Ajoutez une description...(Obligatoire)"
          rows="3"
          autoGrow="true"
          required="true"
        ></ion-textarea>
      </ion-item>
    </ion-list>

    <ion-list lines="full" class="settings-list">
      <ion-item>
        <ion-label class="ion-text-wrap">
          <h3>Rendre public</h3>
          <p>Visible par tous les utilisateurs</p>
        </ion-label>
        <ion-toggle slot="end" [(ngModel)]="content.isPublic"></ion-toggle>
      </ion-item>
      
      <ion-item>
        <ion-label class="ion-text-wrap">
          <h3>Autoriser les commentaires</h3>
          <p>Les utilisateurs pourront commenter votre publication</p>
        </ion-label>
        <ion-toggle slot="end" [(ngModel)]="content.allowComments"></ion-toggle>
      </ion-item>
      
      <ion-item>
        <ion-label class="ion-text-wrap">
          <h3>Autoriser le téléchargement</h3>
          <p>Les utilisateurs pourront télécharger votre média</p>
        </ion-label>
        <ion-toggle slot="end" [(ngModel)]="content.allowDownloads"></ion-toggle>
      </ion-item>
    </ion-list>
  </div>
<!-- Étape 3: Sélection du défi (uniquement en mode normal) -->
<div *ngIf="currentStep === 3 && isModalMode === false" class="challenge-step ion-padding">
  <h2>Associer à un défi</h2>
  <p class="ion-margin-bottom">Sélectionnez un défi existant (optionnel)</p>

  <ion-list>
    <ion-radio-group [(ngModel)]="selectedChallengeId">
      <ion-list-header>
        <ion-label>Défis disponibles</ion-label>
      </ion-list-header>

      <ion-item *ngFor="let challenge of challenges">
        <ion-radio slot="start" [value]="challenge.id"></ion-radio>
        <ion-label class="ion-text-wrap">
          <h3>{{ challenge.name }}</h3>
          <p *ngIf="challenge.description">{{ challenge.description }}</p>
        </ion-label>
      </ion-item>

      <ion-item>
        <ion-radio slot="start" [value]="null"></ion-radio>
        <ion-label class="ion-text-wrap">
          <h3>Ne pas associer à un défi</h3>
        </ion-label>
      </ion-item>
    </ion-radio-group>
  </ion-list>
</div>


<!-- Étape 3 ou 4: Vérification (mode modal) -->
<div *ngIf="(currentStep === 3 && isModalMode === true) || (currentStep === 4 && isModalMode === false) " class="preview-step tiktok-preview">
  <!-- Conteneur principal style TikTok -->
  <div class="post-preview">
    <!-- Média en arrière-plan -->
    <div class="video-container">
      <img *ngIf="isImage()" [src]="previewUrl" class="video-thumbnail" [class.fit-to-screen]="imageFitMode === 'fit'">
      <video *ngIf="isVideo()" [src]="previewUrl" class="video-thumbnail" [class.fit-to-screen]="imageFitMode === 'fit'" autoplay muted loop></video>
      <div class="video-overlay"></div>
    </div>

    <!-- Contenu principal par-dessus -->
    <div class="main-content">
      <div class="artist-info">
        <div class="artist-header">
          <img [src]="'assets/avatar-default.png'" class="artist-avatar">
          <div class="artist-details">
            <div class="profile-header">
              <ion-chip *ngIf="challengeId" color="danger">Défi associé</ion-chip>
              <h4 class="profile-name">{{ content.userId || 'Utilisateur' }}</h4>
            </div>
            
            <div class="artist-name">
              <span>{{ content.description }}</span>
            </div>
            
            <p class="artist-location">
              <span class="post-date">{{ 'Maintenant' }}</span>
              <span class="separator">•</span>
              <span class="post-views">0 vues</span>
            </p>
          </div>
        </div>
      </div>

      <!-- Actions latérales -->
      <div class="side-actions">
        <button class="action-button">
          <div class="action-icon">
            <ion-icon name="heart-outline"></ion-icon>
          </div>
          <span class="action-count">0</span>
        </button>
        <button class="action-button">
          <div class="action-icon">
            <ion-icon name="chatbubble-outline"></ion-icon>
          </div>
          <span class="action-count">0</span>
        </button>
        <button class="action-button">
          <div class="action-icon">
            <ion-icon name="share-outline"></ion-icon>
          </div>
          <span class="action-count">0</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Boutons de cadrage en bas (en dehors du preview) -->
  <div class="crop-controls">
    <button 
      class="crop-btn" 
      [class.active]="imageFitMode === 'default'"
      (click)="setImageFitMode('default')"
    >
      <ion-icon name="expand"></ion-icon>
      <span>Cadrage par défaut</span>
    </button>
    <button 
      class="crop-btn" 
      [class.active]="imageFitMode === 'fit'"
      (click)="setImageFitMode('fit')"
    >
      <ion-icon name="contract"></ion-icon>
      <span>Adapter à l'écran</span>
    </button>
  </div>
</div>
</ion-content>